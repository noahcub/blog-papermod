<!DOCTYPE html>
<html lang="en" dir="auto" data-theme="auto">

<head><meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
<meta name="robots" content="index, follow">
<title>Borg Backups | Las notas de Noah</title>
<meta name="keywords" content="Backups">
<meta name="description" content="Backups con borg en server y PC">
<meta name="author" content="">
<link rel="canonical" href="https://blog.lasnotasdenoah.com/posts/borg-backups/">
<link crossorigin="anonymous" href="/assets/css/stylesheet.cc6ab8f5faa8dc572f6069a132a436924276a646309355c961678b4646b2099f.css" integrity="sha256-zGq49fqo3FcvYGmhMqQ2kkJ2pkYwk1XJYWeLRkayCZ8=" rel="preload stylesheet" as="style">
<link rel="icon" href="https://blog.lasnotasdenoah.com/favicon.ico">
<link rel="icon" type="image/png" sizes="16x16" href="https://blog.lasnotasdenoah.com/favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="https://blog.lasnotasdenoah.com/favicon-32x32.png">
<link rel="apple-touch-icon" href="https://blog.lasnotasdenoah.com/apple-touch-icon.png">
<link rel="mask-icon" href="https://blog.lasnotasdenoah.com/safari-pinned-tab.svg">
<meta name="theme-color" content="#2e2e33">
<meta name="msapplication-TileColor" content="#2e2e33">
<link rel="alternate" hreflang="en" href="https://blog.lasnotasdenoah.com/posts/borg-backups/">
<noscript>
    <style>
        #theme-toggle,
        .top-link {
            display: none;
        }

    </style>
    <style>
        @media (prefers-color-scheme: dark) {
            :root {
                --theme: rgb(29, 30, 32);
                --entry: rgb(46, 46, 51);
                --primary: rgb(218, 218, 219);
                --secondary: rgb(155, 156, 157);
                --tertiary: rgb(65, 66, 68);
                --content: rgb(196, 196, 197);
                --code-block-bg: rgb(46, 46, 51);
                --code-bg: rgb(55, 56, 62);
                --border: rgb(51, 51, 51);
                color-scheme: dark;
            }

            .list {
                background: var(--theme);
            }

            .toc {
                background: var(--entry);
            }
        }

        @media (prefers-color-scheme: light) {
            .list::-webkit-scrollbar-thumb {
                border-color: var(--code-bg);
            }
        }

    </style>
</noscript>
<script>
    if (localStorage.getItem("pref-theme") === "dark") {
        document.querySelector("html").dataset.theme = 'dark';
    } else if (localStorage.getItem("pref-theme") === "light") {
       document.querySelector("html").dataset.theme = 'light';
    } else if (window.matchMedia('(prefers-color-scheme: dark)').matches) {
        document.querySelector("html").dataset.theme = 'dark';
    } else {
        document.querySelector("html").dataset.theme = 'light';
    }

</script><meta property="og:url" content="https://blog.lasnotasdenoah.com/posts/borg-backups/">
  <meta property="og:site_name" content="Las notas de Noah">
  <meta property="og:title" content="Borg Backups">
  <meta property="og:description" content="Backups con borg en server y PC">
  <meta property="og:locale" content="es-es">
  <meta property="og:type" content="article">
    <meta property="article:section" content="posts">
    <meta property="article:published_time" content="2025-08-21T13:40:36+02:00">
    <meta property="article:modified_time" content="2025-08-21T13:40:36+02:00">
    <meta property="article:tag" content="Backups">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Borg Backups">
<meta name="twitter:description" content="Backups con borg en server y PC">


<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BreadcrumbList",
  "itemListElement": [
    {
      "@type": "ListItem",
      "position":  1 ,
      "name": "Posts",
      "item": "https://blog.lasnotasdenoah.com/posts/"
    }, 
    {
      "@type": "ListItem",
      "position":  2 ,
      "name": "Borg Backups",
      "item": "https://blog.lasnotasdenoah.com/posts/borg-backups/"
    }
  ]
}
</script>
<script type="application/ld+json">
{
  "@context": "https://schema.org",
  "@type": "BlogPosting",
  "headline": "Borg Backups",
  "name": "Borg Backups",
  "description": "Backups con borg en server y PC",
  "keywords": [
    "Backups"
  ],
  "articleBody": "Configuración de Backups con Borg Nuestro servidor de Unraid va a servir para guardar los backups de nuestras máquinas. En concreto vamos a guardar los backups de los equipos (portátiles y móviles) a través de Vorta, del VPS y del servidor Debian sanMi.\nEsta necesidad ha surgido por dos temas distintos:\nEl primero es la necesidad de hacer backup de nuestros servidores secundarios. Podría instalar Duplicacy, que es el sistema que uso para hacer backup de unRaid en la cuenta de GoogleDrive pero visto lo bien que habla todo el mundo de borg vamos a probarlo una temporada.\nSegundo, los equipos de oficina estaban configurados con Gnome y usando la herramienta Deja-dup hacía los backups. El problema es que Deja-dup no funciona con KDE y me he visto obligado a emplear otra aplicación. Kbackup es una buena opción, pero no acaba de convencerme. Vorta me parece que es una opción excelente así que vamos a ello.\nInstalación de borgserver Buscamos en aplicaciones Unraid el servidor borg:\nRepository: nold360/borgserver:latest Network Type: Bridge SSH: 2222 # Ubicación de las claves ssh sshkeys:/mnt/user/appdata/borg/sshkeys/ # Ubicación de los backups backup: /mnt/user/Backups/borg Pulsamos en aplicar y no arranca el contenedor. El motivo es que si no hemos añadido alguna clave ssh antes no arrancará.\nEn la web del proyecto de hub.docker.com lo explica: !IMPORTANT!: The container wouldn’t start the SSH-Deamon until there is at least one ssh-keyfile in this directory!\nCopiamos nuestra clave pública a la siguiente ruta: /mnt/user/appdata/borg/sshkeys/clients En el momento de hacer este manual tengo dos claves públicas, la del pc portátil y la del servidor sanmi:\n➜ clients pwd /mnt/user/appdata/borg/sshkeys/clients ➜ clients ls envy_kde.pub sanmi.pub Ahora si reiniciamos el contenedor debería arrancar sin problemas\nInstalación de Vorta Backup en Fedora En mi caso he instalado Vorta a través de Discover en formato flatpak.\nIniciamos Vorta y comenzamos el procedimiento:\nPrimero creamos nuestra clave ssh:\nUna vez creada la clave ssh tenemos que copiarla a nuestro servidor borg a la siguiente ruta:\n/mnt/user/appdata/borg/sshkeys/clients Añadimos nuestro repositorio de Borg:\nEs importante verificar correctamente los datos del repositorio. En mi caso:\nPESTAÑA GENERAL: Repository URL: ssh://borg@DIRECCION_IP_TAILSCALE:2222/./envy Repository name: envy Enter passphrase: XXXXXXXXX PESTAÑA ADVANCED: SSH Key: seleccionamos la clave ssh que hemos creado anteriormente Encryption: Repokey-Blake2 El resto de opciones las dejamos por defecto.\nPlanificamos la programación tanto de backups como de prune:\nIMPORTANTE: En los Settings de Vorta debemos marcar “Automatically start Vorta at login” para que arranque al inicio.\nCon esto debería funcionar ya nuestro primer backup. Para restaurar es muy sencillo a través de Vorta. Procedemos a montar el backup que nos interese y realizamos la copia a nuestro sistema.\nConfiguración del cliente borgmatic en los servidores (modo consola) Esta parte es un poco más compleja porque se hace todo en modo consola, pero una vez configurada resulta todo muy sencillo.\nLa configuración consiste en varios pasos (Nota: las claves empleadas en este manual son ficticias):\nInstalación de borgmatic. Borgmatic nos permite realizar backups con borg a través de un sencillo fichero de configuración. Instalación de gpg y pass que nos harán falta para encriptar los backups en destino. Creamos nuestra contraseña gpg para almacenar el password de encriptado de la copia de seguridad. Creamos nueva clave ssh para logearse en nuestro servidor destino de los backups. Configuramos nuestro fichero config.yaml para borgmatic. Creamos nuestra pass para encriptar la copia de seguridad Añadimos una entrada a crontab para programar los backups y las limpiezas. Instalación de borgmatic sudo apt install borgmatic Instalación de gpg y pass sudo apt install pass gpg Creación clave gpg Configuramos nuestra clave gpg:\nsudo gpg --full-generate-key Tipo de clave: predeterminada Validez: sin caducidad Rellenamos nuestros datos personales y de correo: Nuestra contraseña para proteger la clave: Por último nos muestra un resumen de la clave creada: Si queremos ver nuevamente la clave ejecutamos el siguiente comando:\nsudo gpg --list-secret-keys --keyid-format LONG Nos genera la siguiente salida:\n[sudo] password for XXXXXXXXXXXXX: /root/.gnupg/pubring.kbx ------------------------ sec XXXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXX 2025-07-30 [SC] XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX uid [ultimate] xxxxxx XXXXXXXXXXXXXXX ssb XXXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXX 2025-07-30 [E] Creación de claves ssh sudo ssh-keygen -o -a 100 -t ed25519 Ponemos el nombre de fichero que vamos a usar para almacenar la clave y el resto lo dejamos sin contraseña. Una vez tenemos nuestra clave ssh la pasamos al servidor borgserver de Unraid (tenemos varias opciones con scp, ssh-cp-id, o creando el fichero a mano y añadiendo el contenido):\n# Servidor Unraid cd /mnt/user/appdata/borg/sshkeys/clients nano my_server.pub # y pegamos el contenido de la clave ssh.pub Posteriormente reiniciamos el servidor borg:\ndocker restart borgserver ### docker logs borgserver #### ######################################################## * Testing Volume BORG_DATA_DIR: /backup * Testing Volume SSH_KEY_DIR: /sshkeys * Checking / Preparing SSH Host-Keys... ######################################################## * Starting SSH-Key import... ** Adding client envy_kde.pub with repo path /backup/envy_kde.pub ** Adding client my_server.pub with repo path /backup/my_server.pub En la salida vemos que ya se ha añadido la nueva clave ssh a nuestro servidor borg.\nConfiguramos nuestro fichero config.yaml para borgmatic Generamos el fichero por defecto para borgmatic\nsudo generate-borgmatic-config # Hacemos una copia por seguridad sudo cp /etc/borgmatic/config.yaml /etc/borgmatic/config.yaml.bak # Editamos el fichero Editamos el fichero:\nsudo nano /etc/borgmatic/config.yaml Contenido definitivo del fichero de configuración de borgmatic:\n# /etc/borgmatic/config.yaml location: source_directories: - /home/mi_usuario repositories: - ssh://borg@MY_SERVER_IP_TAILSCALE:2222/./mi_nombre_del_repositorio exclude_caches: true exclude_patterns: - '*.pyc' - /home/*/.cache storage: compression: auto,zstd encryption_passphrase: pass /super_admin@mi_compañía.com/borg-repokey archive_name_format: \"{hostname}-{now}\" ssh_command: ssh -i /root/.ssh/my_server_ssh_key # Number of times to retry a failing backup # Needs recent Borgmatic version retries: 5 retry_wait: 5 retention: keep_daily: 3 keep_weekly: 4 keep_monthly: 12 consistency: checks: - disabled # Uncomment to regularly read all repo data # Needs recent Borgmatic version # - name: repository # frequency: 4 weeks # - name: archives # frequency: 8 weeks check_last: 3 Llegado a este punto ya está casi todo hecho, pero debemos prestar atención a esta parte del fichero:\nencryption_passphrase: pass /super_admin@mi_compañía.com/borg-repokey\nTenemos que generar nuestra pass para encritar la copia de seguridad. Vamos a ello.\nCreamos nuestra pass para encriptar la copia de seguridad sudo pass generate /super_admin@mi_compañía.com/borg-repokey 16 Nos pedirá la contraseña de nuestro gpg para encriptarla y nos la crea.\nPara ver lista de contraseñas:\nsudo pass list Si queremos ver la contraseña:\nsudo pass list /super_admin@mi_compañía.com/borg-repokey 16 Si queremos editar la contraseña:\nsudo pass edit /super_admin@mi_compañía.com/borg-repokey 16 Y con esto ya está creada y lista para se usada en nuestro fichero config.yaml de borgmatic.\nVerificamos que nuestro fichero config.yaml no contenga errores:\nsudo validate-borgmatic-config -c /etc/borgmatic/config.yaml Primer backup El manejo de borgmatic en modo consola está muy bien explicado en la web docs.borgbase.com.\nsudo env \"PATH=$PATH\" validate-borgmatic-config sudo env \"PATH=$PATH\" borgmatic init --encryption repokey-blake2 sudo borgmatic create --list --stats Verificamos que lo ha creado:\nsudo borgmatic list ssh://borg@IP_My_server:2222/./my_repo: Listing archives my_server-2025-07-30T04:22:14 Wed, 2025-07-30 04:22:17 [f920bbec8c5f1ff80cfb794b801f1a3d55b3a90a52047f37bf8035e57902fb51] Añadimos una entrada a crontab para programar los backups y las limpiezas. Vamos a programar nuestros backups y limpiezas a las 08.00 horas todos los días:\nsudo crontab -e # For more information see the manual pages of crontab(5) and cron(8) # # m h dom mon dow command 0 8 * * * /usr/bin/borgmatic --stats -v 0 2\u003e\u00261 INFORMACIÓN IMPORTANTE SOBRE EL COMANDO BORGMATIC\nEn el repositorio de github borgmatic-collective nos dice lo siguiente:\nIf you omit create and other actions, borgmatic runs through a set of default actions: prune any old backups as per the configured retention policy, compact segments to free up space (with Borg 1.2+, borgmatic 1.5.23+), create a backup, and check backups for consistency problems due to things like file damage. For instance:\nsudo borgmatic --verbosity 1 --list --stats En resumen, cuando no añadimos otras opciones a borgmatica, éste ejecuta de forma automática por defecto las siguientes operaciones: Prune, Compact, Backups y Check de backup, lo que me parece ideal para añadir el comando en cron.\nRestaurar el backup Esta la segunda parte más importante. He realizado varias pruebas y todo ha funcionado correctamente. Para restaurar el backup primero hacemos un listado de los que tenemos y después montamos el backup en la ubicación deseada para restaurar los ficheros:\nPrimero listamos los ficheros creados con borgmatic:\nsudo borgmatic list Una vez sabemos el fichero que nos interesa podemos ver el contenido:\nsudo borgmatic list --archive server-2020-04-01 Extracción completa de ficheros:\nsudo borgmatic extract --archive my_server-2025-07-30T04:24:04 --destination /mnt/new-directory Extracción de una parte solamente:\nsudo borgmatic extract --archive my_server-2020-04-01 --path mnt/catpics --destination /mnt/new-directory Notificaciones del Backup usando apprise Instalamos el software necesario. Según su github Apprise permite enviar una notificación a casi todos los servicios de notificación más populares disponibles en la actualidad, como: Telegram, Discord, Slack, Amazon SNS, Gotify, etc.\nInstalación es sencilla:\nsudo apt install apprise Configuración de nuestro fichero borgmatic conf:\nsudo nano /etc/borgmatic/config.yaml #### AÑADIMOS ESTO AL FINAL de nuestro fichero de configuración hooks: before_backup: - echo \"Starting a backup job.\" after_backup: - echo \"Backup created.\" - apprise -vv -t \"✅ SUCCESS Backup My_Server\" -b \"$(cat /tmp/backup_run.log)\" \"mailtos://smtp.gmail.com:587?user=super_admin@gmail.com\u0026pass=superpasssecreta\u0026from=superadmin@gmail.com\u0026to=superadmin@hotmail.com,tgram://bot_token:de_telegram/chat_id_telegram/\" on_error: - echo \"Error while creating a backup.\" - apprise -vv -t \"❌ FAILED Backup My_Server\" -b \"$(cat /tmp/backup_run.log)\" \"mailtos://smtp.gmail.com:587?user=super_admin@gmail.com\u0026pass=superpasssecreta\u0026from=superadmin@gmail.com\u0026to=superadmin@hotmail.com,tgram://bot_token:de_telegram/chat_id_telegram/\" En mi caso he configurado para que nos envíe dos notificaciones. La primera por correo electrónico y la segunda a Telegram.\nEn la versión de borgmatic 1.8.4+ Apprise se integra de forma nativa con borgmatic, lo que permite una configuración mucho más limpia, tal y como se muestra en la siguiente ejemplo. Esta configuración yo no puedo usarla porque mi sistema tiene la versión borgmatic 1.7.7:\napprise: states: - start - finish - fail services: - url: mailtos://smtp.example.com:587?user=server@example.com\u0026pass=YourSecurePassword\u0026from=server@example.com\u0026to=receiver@example.com label: mail - url: slack://token@Txxxx/Bxxxx/Cxxxx label: slack start: title: ⚙️ Started body: Starting backup process. finish: title: ✅ SUCCESS body: Backups successfully made. fail: title: ❌ FAILED body: Your backups have failed. En la versión 1.8.9+, los logs de borgmatic son añadidos automaticamenta al cuerpo de las notificaciones de apprise. Me parece una colaboración impresionante. Que ganas tengo de que actualice Debian a la nueva versión de borgmatic.\nPor último, modificamos nuestro crontab para que al ejecutarse guarde la salida de las estadísticas en el fichero /tmp/backup_run.log.\nsudo crontab -e # # # 30 8 * * * /usr/bin/borgmatic --stats -v 0 \u003e /tmp/backup_run.log Con esto, nuestro borgmatica ya debería notificarnos:\nCorreo:\nTelegram:\nNotas finales a tener en cuenta En mi servidor sanmi tengo instalado Fedora Server. En este caso, la versión de borgmatic que nos acompaña es la versión 2.0.6 por lo que ya disponemos de las nuevas características para notificaciones y de un nuevo formato en el fichero config.yaml.\nRespecto a la configuración de encryption_passcommand en borgmatic, se me presenta un problema.\nSi programamos el backup con cron, no se ejecuta. El motivo es que cada vez que se va a ejecutar, el comando pass nos solicita nuestra contraseña de la clave gpg y si no la introducimos el resto no continúa. Entonces, para que los backups se realicen de forma automática sin intervención del usuario, la única forma que he conseguido hacerlo es poniendo la contraseña directamente en el fichero config.yaml.\nConfiguración de mi fichero config.yaml en Fedora Server:\nsource_directories: - /home/AppData - /home/super_admin repositories: - path: ssh://borg@100.100.100.100:2222/./sanMi label: sanMi exclude_caches: true exclude_patterns: - '*.pyc' - /home/*/.cache compression: auto,zstd encryption_passphrase: My_super_password #encryption_passcommand: pass /super_admin@gmail.com/borg-repokey archive_name_format: \"{hostname}-{now}\" ssh_command: ssh -i /root/.ssh/sanmi retries: 5 retry_wait: 5 keep_daily: 3 keep_weekly: 4 keep_monthly: 12 checks: - name: repository frequency: 4 weeks - name: archives frequency: 8 weeks check_last: 3 apprise: states: - start - finish - fail services: - url: mailtos://smtp.gmail.com:587?user=super_admin_@gmail.com\u0026pass=super_password\u0026from=super_admin@gmail.com\u0026to=destino@hotmail.com label: mail - url: tgram://123456789:AAE39Q5XXXXXXXXXXXXXXX_XXXXXXXXXXXXXXXXXXXxPGrI/XXXXXXXXXXXX/ label: telegram start: title: ⚙️ Starrted Backup body: Starting backup process finish: title: ✅ SUCCESS Backup SanMi body: Backup SanMi success fail: title: ❌ FAILED Backup SanMi body: Backups SanMi failed Fuentes y enlaces de interés que ayudaran a complementar esta guía:\nBorgserver en hub.docker.com Guía muy completa, base de casi todo el manual\nGuía en español con detalle de uso contraseña cifrado\nTutorial bilito para configurar borg en Unraid\nGuía en español configuración pass y claves gpg para almacenar esas pass\nConfiguración de pass como password-manager en consola\nDocumentación Borgbase.com\nGithub de borgmatic-collective con ejemplos varios\nNotificaciones con apprise\nGithub de borgmatic-collective notificaciones apprise\nDoc notificaciones apprise Telegram\n",
  "wordCount" : "1999",
  "inLanguage": "en",
  "datePublished": "2025-08-21T13:40:36+02:00",
  "dateModified": "2025-08-21T13:40:36+02:00",
  "mainEntityOfPage": {
    "@type": "WebPage",
    "@id": "https://blog.lasnotasdenoah.com/posts/borg-backups/"
  },
  "publisher": {
    "@type": "Organization",
    "name": "Las notas de Noah",
    "logo": {
      "@type": "ImageObject",
      "url": "https://blog.lasnotasdenoah.com/favicon.ico"
    }
  }
}
</script>
</head>
<body id="top">
    <header class="header">
    <nav class="nav">
        <div class="logo">
            <a href="https://blog.lasnotasdenoah.com/" accesskey="h" title="Las notas de Noah (Alt + H)">Las notas de Noah</a>
            <div class="logo-switches">
                <button id="theme-toggle" accesskey="t" title="(Alt + T)" aria-label="Toggle theme">
                    <svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"></path>
                    </svg>
                    <svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="18" viewBox="0 0 24 24"
                        fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                        stroke-linejoin="round">
                        <circle cx="12" cy="12" r="5"></circle>
                        <line x1="12" y1="1" x2="12" y2="3"></line>
                        <line x1="12" y1="21" x2="12" y2="23"></line>
                        <line x1="4.22" y1="4.22" x2="5.64" y2="5.64"></line>
                        <line x1="18.36" y1="18.36" x2="19.78" y2="19.78"></line>
                        <line x1="1" y1="12" x2="3" y2="12"></line>
                        <line x1="21" y1="12" x2="23" y2="12"></line>
                        <line x1="4.22" y1="19.78" x2="5.64" y2="18.36"></line>
                        <line x1="18.36" y1="5.64" x2="19.78" y2="4.22"></line>
                    </svg>
                </button>
            </div>
        </div>
        <ul id="menu">
            <li>
                <a href="https://blog.lasnotasdenoah.com/search/" title="Buscar (Alt &#43; /)" accesskey=/>
                    <span>Buscar</span>
                </a>
            </li>
            <li>
                <a href="https://blog.lasnotasdenoah.com/posts/" title="Publicaciones">
                    <span>Publicaciones</span>
                </a>
            </li>
            <li>
                <a href="https://blog.lasnotasdenoah.com/archives/" title="Archivo">
                    <span>Archivo</span>
                </a>
            </li>
            <li>
                <a href="https://blog.lasnotasdenoah.com/categories/" title="Categorías">
                    <span>Categorías</span>
                </a>
            </li>
            <li>
                <a href="https://blog.lasnotasdenoah.com/tags/" title="Etiquetas">
                    <span>Etiquetas</span>
                </a>
            </li>
        </ul>
    </nav>
</header>
<main class="main">

<article class="post-single">
  <header class="post-header">
    
    <h1 class="post-title entry-hint-parent">
      Borg Backups
    </h1>
    <div class="post-description">
      Backups con borg en server y PC
    </div>
    <div class="post-meta"><span title='2025-08-21 13:40:36 +0200 CEST'>August 21, 2025</span>

</div>
  </header> <div class="toc">
    <details >
        <summary accesskey="c" title="(Alt + C)">
            <span class="details">Table of Contents</span>
        </summary>

        <div class="inner"><ul>
                <li>
                    <a href="#configuraci%c3%b3n-de-backups-con-borg" aria-label="Configuración de Backups con Borg">Configuración de Backups con Borg</a><ul>
                        
                <li>
                    <a href="#instalaci%c3%b3n-de-borgserver" aria-label="Instalación de borgserver">Instalación de borgserver</a></li>
                <li>
                    <a href="#instalaci%c3%b3n-de-vorta-backup-en-fedora" aria-label="Instalación de Vorta Backup en Fedora">Instalación de Vorta Backup en Fedora</a></li>
                <li>
                    <a href="#configuraci%c3%b3n-del-cliente-borgmatic-en-los-servidores-modo-consola" aria-label="Configuración del cliente borgmatic en los servidores (modo consola)">Configuración del cliente borgmatic en los servidores (modo consola)</a></li>
                <li>
                    <a href="#instalaci%c3%b3n-de-borgmatic" aria-label="Instalación de borgmatic">Instalación de borgmatic</a></li>
                <li>
                    <a href="#instalaci%c3%b3n-de-gpg-y-pass" aria-label="Instalación de gpg y pass">Instalación de gpg y pass</a></li>
                <li>
                    <a href="#creaci%c3%b3n-clave-gpg" aria-label="Creación clave gpg">Creación clave gpg</a></li>
                <li>
                    <a href="#creaci%c3%b3n-de-claves-ssh" aria-label="Creación de claves ssh">Creación de claves ssh</a></li>
                <li>
                    <a href="#configuramos-nuestro-fichero-configyaml-para-borgmatic" aria-label="Configuramos nuestro fichero config.yaml para borgmatic">Configuramos nuestro fichero config.yaml para borgmatic</a></li>
                <li>
                    <a href="#creamos-nuestra-pass-para-encriptar-la-copia-de-seguridad" aria-label="Creamos nuestra pass para encriptar la copia de seguridad">Creamos nuestra pass para encriptar la copia de seguridad</a></li>
                <li>
                    <a href="#primer-backup" aria-label="Primer backup">Primer backup</a></li>
                <li>
                    <a href="#a%c3%b1adimos-una-entrada-a-crontab-para-programar-los-backups-y-las-limpiezas" aria-label="Añadimos una entrada a crontab para programar los backups y las limpiezas.">Añadimos una entrada a crontab para programar los backups y las limpiezas.</a></li>
                <li>
                    <a href="#restaurar-el-backup" aria-label="Restaurar el backup">Restaurar el backup</a></li>
                <li>
                    <a href="#notificaciones-del-backup-usando-apprise" aria-label="Notificaciones del Backup usando apprise">Notificaciones del Backup usando apprise</a></li>
                <li>
                    <a href="#notas-finales-a-tener-en-cuenta" aria-label="Notas finales a tener en cuenta">Notas finales a tener en cuenta</a>
                </li>
            </ul>
            </li>
            </ul>
        </div>
    </details>
</div>

  <div class="post-content"><h2 id="configuración-de-backups-con-borg">Configuración de Backups con Borg<a hidden class="anchor" aria-hidden="true" href="#configuración-de-backups-con-borg">#</a></h2>
<p>Nuestro servidor de Unraid va a servir para guardar los backups de nuestras máquinas. En concreto vamos a guardar los backups de los equipos (portátiles y móviles) a través de Vorta, del VPS y del servidor Debian sanMi.<br>
Esta necesidad ha surgido por dos temas distintos:<br>
El primero es la necesidad de hacer backup de nuestros servidores secundarios. Podría instalar Duplicacy, que es el sistema que uso para hacer backup de unRaid en la cuenta de GoogleDrive pero visto lo bien que habla todo el mundo de borg vamos a probarlo una temporada.<br>
Segundo, los equipos de oficina estaban configurados con Gnome y usando la herramienta Deja-dup hacía los backups. El problema es que Deja-dup no funciona con KDE y me he visto obligado a emplear otra aplicación. Kbackup es una buena opción, pero no acaba de convencerme. Vorta me parece que es una opción excelente así que vamos a ello.</p>
<h3 id="instalación-de-borgserver">Instalación de borgserver<a hidden class="anchor" aria-hidden="true" href="#instalación-de-borgserver">#</a></h3>
<p>Buscamos en aplicaciones Unraid el servidor borg:</p>
<p><img alt="borg-1.png" loading="lazy" src="/posts/borg-backups/borg-1.png"></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Repository: nold360/borgserver:latest
</span></span><span style="display:flex;"><span>Network Type: Bridge
</span></span><span style="display:flex;"><span>SSH: <span style="color:#ae81ff">2222</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ubicación de las claves ssh</span>
</span></span><span style="display:flex;"><span>sshkeys:/mnt/user/appdata/borg/sshkeys/
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Ubicación de los backups</span>
</span></span><span style="display:flex;"><span>backup: /mnt/user/Backups/borg
</span></span></code></pre></div><p>Pulsamos en aplicar y no arranca el contenedor. El motivo es que si no hemos añadido alguna clave ssh antes no arrancará.<br>
En la <a href="https://hub.docker.com/r/nold360/borgserver">web del proyecto</a> de hub.docker.com lo explica:
<strong>!IMPORTANT!: The container wouldn&rsquo;t start the SSH-Deamon until there is at least one ssh-keyfile in this directory!</strong></p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>Copiamos nuestra clave pública a la siguiente ruta:
</span></span><span style="display:flex;"><span>/mnt/user/appdata/borg/sshkeys/clients
</span></span></code></pre></div><p>En el momento de hacer este manual tengo dos claves públicas, la del pc portátil y la del servidor sanmi:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>➜  clients pwd
</span></span><span style="display:flex;"><span>/mnt/user/appdata/borg/sshkeys/clients
</span></span><span style="display:flex;"><span>➜  clients ls   
</span></span><span style="display:flex;"><span>envy_kde.pub  sanmi.pub
</span></span></code></pre></div><p>Ahora si reiniciamos el contenedor debería arrancar sin problemas</p>
<p><img alt="borg-2.png" loading="lazy" src="/posts/borg-backups/borg-2.png"></p>
<h3 id="instalación-de-vorta-backup-en-fedora">Instalación de Vorta Backup en Fedora<a hidden class="anchor" aria-hidden="true" href="#instalación-de-vorta-backup-en-fedora">#</a></h3>
<p>En mi caso he instalado Vorta a través de Discover en formato flatpak.<br>
Iniciamos Vorta y comenzamos el procedimiento:</p>
<p>Primero creamos nuestra clave ssh:</p>
<p><img alt="borg-3.png" loading="lazy" src="/posts/borg-backups/borg-3.png"></p>
<p>Una vez creada la clave ssh tenemos que copiarla a nuestro servidor borg a la siguiente ruta:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>/mnt/user/appdata/borg/sshkeys/clients
</span></span></code></pre></div><p>Añadimos nuestro repositorio de Borg:</p>
<p><img alt="borg-4.png" loading="lazy" src="/posts/borg-backups/borg-4.png"></p>
<p>Es importante verificar correctamente los datos del repositorio. En mi caso:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>PESTAÑA GENERAL:
</span></span><span style="display:flex;"><span>Repository URL: ssh://borg@DIRECCION_IP_TAILSCALE:2222/./envy
</span></span><span style="display:flex;"><span>Repository name: envy
</span></span><span style="display:flex;"><span>Enter passphrase: XXXXXXXXX
</span></span><span style="display:flex;"><span>PESTAÑA ADVANCED:
</span></span><span style="display:flex;"><span>SSH Key: seleccionamos la clave ssh que hemos creado anteriormente
</span></span><span style="display:flex;"><span>Encryption: Repokey-Blake2
</span></span></code></pre></div><p>El resto de opciones las dejamos por defecto.<br>
Planificamos la programación tanto de backups como de prune:</p>
<p><img alt="borg-5.png" loading="lazy" src="/posts/borg-backups/borg-5.png"></p>
<p>IMPORTANTE: En los Settings de Vorta debemos marcar <strong>&ldquo;Automatically start Vorta at login&rdquo;</strong> para que arranque al inicio.</p>
<p>Con esto debería funcionar ya nuestro primer backup. Para restaurar es muy sencillo a través de Vorta. Procedemos a montar el backup que nos interese y realizamos la copia a nuestro sistema.</p>
<h3 id="configuración-del-cliente-borgmatic-en-los-servidores-modo-consola">Configuración del cliente borgmatic en los servidores (modo consola)<a hidden class="anchor" aria-hidden="true" href="#configuración-del-cliente-borgmatic-en-los-servidores-modo-consola">#</a></h3>
<p>Esta parte es un poco más compleja porque se hace todo en modo consola, pero una vez configurada resulta todo muy sencillo.<br>
La configuración consiste en varios pasos (<strong>Nota: las claves empleadas en este manual son ficticias</strong>):</p>
<ul>
<li>Instalación de <strong>borgmatic</strong>. Borgmatic nos permite realizar backups con borg a través de un sencillo fichero de configuración.</li>
<li>Instalación de <strong>gpg</strong> y <strong>pass</strong> que nos harán falta para encriptar los  backups en destino.</li>
<li>Creamos nuestra contraseña gpg para almacenar el password de encriptado de la copia de seguridad.</li>
<li>Creamos nueva clave ssh para logearse en nuestro servidor destino de los backups.</li>
<li>Configuramos nuestro fichero config.yaml para borgmatic.</li>
<li>Creamos nuestra pass para encriptar la copia de seguridad</li>
<li>Añadimos una entrada a crontab para programar los backups y las limpiezas.</li>
</ul>
<h3 id="instalación-de-borgmatic">Instalación de borgmatic<a hidden class="anchor" aria-hidden="true" href="#instalación-de-borgmatic">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install borgmatic
</span></span></code></pre></div><h3 id="instalación-de-gpg-y-pass">Instalación de gpg y pass<a hidden class="anchor" aria-hidden="true" href="#instalación-de-gpg-y-pass">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install pass gpg
</span></span></code></pre></div><h3 id="creación-clave-gpg">Creación clave gpg<a hidden class="anchor" aria-hidden="true" href="#creación-clave-gpg">#</a></h3>
<p>Configuramos nuestra clave gpg:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo gpg --full-generate-key
</span></span></code></pre></div><p>Tipo de clave: predeterminada
<img alt="borg-client-1.png" loading="lazy" src="/posts/borg-backups/borg-client-1.png"><br>
<img alt="borg-client-2.png" loading="lazy" src="/posts/borg-backups/borg-client-2.png"></p>
<p>Validez: sin caducidad
<img alt="borg-client-3.png" loading="lazy" src="/posts/borg-backups/borg-client-3.png"></p>
<p>Rellenamos nuestros datos personales y de correo:
<img alt="borg-client-4.png" loading="lazy" src="/posts/borg-backups/borg-client-4.png"></p>
<p>Nuestra contraseña para proteger la clave:
<img alt="borg-client-5.png" loading="lazy" src="/posts/borg-backups/borg-client-5.png"></p>
<p>Por último nos muestra un resumen de la clave creada:
<img alt="borg-client-6.png" loading="lazy" src="/posts/borg-backups/borg-client-6.png"></p>
<p>Si queremos ver nuevamente la clave ejecutamos el siguiente comando:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo gpg --list-secret-keys --keyid-format LONG
</span></span></code></pre></div><p>Nos genera la siguiente salida:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#f92672">[</span>sudo<span style="color:#f92672">]</span> password <span style="color:#66d9ef">for</span> XXXXXXXXXXXXX: 
</span></span><span style="display:flex;"><span>/root/.gnupg/pubring.kbx
</span></span><span style="display:flex;"><span>------------------------
</span></span><span style="display:flex;"><span>sec   XXXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXX 2025-07-30 <span style="color:#f92672">[</span>SC<span style="color:#f92672">]</span>
</span></span><span style="display:flex;"><span>      XXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXXX
</span></span><span style="display:flex;"><span>uid                 <span style="color:#f92672">[</span>ultimate<span style="color:#f92672">]</span> xxxxxx XXXXXXXXXXXXXXX &lt;XXXXXXXXXXXXXXX@XXXXXXXXXXXXXXX.com&gt;
</span></span><span style="display:flex;"><span>ssb   XXXXXXXXXX/XXXXXXXXXXXXXXXXXXXXXXXXX 2025-07-30 <span style="color:#f92672">[</span>E<span style="color:#f92672">]</span>
</span></span></code></pre></div><h3 id="creación-de-claves-ssh">Creación de claves ssh<a hidden class="anchor" aria-hidden="true" href="#creación-de-claves-ssh">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo ssh-keygen -o -a <span style="color:#ae81ff">100</span> -t ed25519
</span></span></code></pre></div><p>Ponemos el nombre de fichero que vamos a usar para almacenar la clave y el resto lo dejamos sin contraseña.
<img alt="borg-client-7.png" loading="lazy" src="/posts/borg-backups/borg-client-7.png"></p>
<p>Una vez tenemos nuestra clave ssh la pasamos al servidor borgserver de Unraid (tenemos varias opciones con scp, ssh-cp-id, o creando el fichero a mano y añadiendo el contenido):</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># Servidor Unraid</span>
</span></span><span style="display:flex;"><span>cd /mnt/user/appdata/borg/sshkeys/clients
</span></span><span style="display:flex;"><span>nano my_server.pub
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># y pegamos el contenido de la clave ssh.pub</span>
</span></span></code></pre></div><p>Posteriormente reiniciamos el servidor borg:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>docker restart borgserver
</span></span><span style="display:flex;"><span><span style="color:#75715e">###</span>
</span></span><span style="display:flex;"><span>docker logs borgserver
</span></span><span style="display:flex;"><span><span style="color:#75715e">####</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">########################################################</span>
</span></span><span style="display:flex;"><span> * Testing Volume BORG_DATA_DIR: /backup
</span></span><span style="display:flex;"><span> * Testing Volume SSH_KEY_DIR: /sshkeys
</span></span><span style="display:flex;"><span> * Checking / Preparing SSH Host-Keys...
</span></span><span style="display:flex;"><span><span style="color:#75715e">########################################################</span>
</span></span><span style="display:flex;"><span> * Starting SSH-Key import...
</span></span><span style="display:flex;"><span>  ** Adding client envy_kde.pub with repo path /backup/envy_kde.pub
</span></span><span style="display:flex;"><span>  ** Adding client my_server.pub with repo path /backup/my_server.pub
</span></span></code></pre></div><p>En la salida vemos que ya se ha añadido la nueva clave ssh a nuestro servidor borg.</p>
<h3 id="configuramos-nuestro-fichero-configyaml-para-borgmatic">Configuramos nuestro fichero config.yaml para borgmatic<a hidden class="anchor" aria-hidden="true" href="#configuramos-nuestro-fichero-configyaml-para-borgmatic">#</a></h3>
<p>Generamos el fichero por defecto para borgmatic</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo generate-borgmatic-config
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Hacemos una copia por seguridad</span>
</span></span><span style="display:flex;"><span>sudo cp /etc/borgmatic/config.yaml /etc/borgmatic/config.yaml.bak
</span></span><span style="display:flex;"><span><span style="color:#75715e"># Editamos el fichero</span>
</span></span></code></pre></div><p>Editamos el fichero:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo nano /etc/borgmatic/config.yaml
</span></span></code></pre></div><p>Contenido definitivo del fichero de configuración de borgmatic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span><span style="color:#75715e"># /etc/borgmatic/config.yaml</span>
</span></span><span style="display:flex;"><span>location:
</span></span><span style="display:flex;"><span>  source_directories:
</span></span><span style="display:flex;"><span>    - /home/mi_usuario
</span></span><span style="display:flex;"><span>  repositories:
</span></span><span style="display:flex;"><span>    - ssh://borg@MY_SERVER_IP_TAILSCALE:2222/./mi_nombre_del_repositorio
</span></span><span style="display:flex;"><span>  exclude_caches: true
</span></span><span style="display:flex;"><span>  exclude_patterns:
</span></span><span style="display:flex;"><span>    - <span style="color:#e6db74">&#39;*.pyc&#39;</span>
</span></span><span style="display:flex;"><span>    - /home/*/.cache
</span></span><span style="display:flex;"><span>storage:
</span></span><span style="display:flex;"><span>  compression: auto,zstd
</span></span><span style="display:flex;"><span>  encryption_passphrase: pass /super_admin@mi_compañía.com/borg-repokey
</span></span><span style="display:flex;"><span>  archive_name_format: <span style="color:#e6db74">&#34;{hostname}-{now}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  ssh_command: ssh -i /root/.ssh/my_server_ssh_key
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Number of times to retry a failing backup</span>
</span></span><span style="display:flex;"><span>  <span style="color:#75715e"># Needs recent Borgmatic version</span>
</span></span><span style="display:flex;"><span>  retries: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>  retry_wait: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>retention:
</span></span><span style="display:flex;"><span>  keep_daily: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>  keep_weekly: <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>  keep_monthly: <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>consistency:
</span></span><span style="display:flex;"><span>  checks:
</span></span><span style="display:flex;"><span>    - disabled
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Uncomment to regularly read all repo data</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># Needs recent Borgmatic version</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># - name: repository</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   frequency: 4 weeks</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e"># - name: archives</span>
</span></span><span style="display:flex;"><span>    <span style="color:#75715e">#   frequency: 8 weeks</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  check_last: <span style="color:#ae81ff">3</span>
</span></span></code></pre></div><p>Llegado a este punto ya está casi todo hecho, pero debemos prestar atención a esta parte del fichero:</p>
<p><strong>encryption_passphrase: pass /super_admin@mi_compañía.com/borg-repokey</strong></p>
<p>Tenemos que generar nuestra pass para encritar la copia de seguridad. Vamos a ello.</p>
<h3 id="creamos-nuestra-pass-para-encriptar-la-copia-de-seguridad">Creamos nuestra pass para encriptar la copia de seguridad<a hidden class="anchor" aria-hidden="true" href="#creamos-nuestra-pass-para-encriptar-la-copia-de-seguridad">#</a></h3>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo pass generate /super_admin@mi_compañía.com/borg-repokey <span style="color:#ae81ff">16</span>
</span></span></code></pre></div><p>Nos pedirá la contraseña de nuestro gpg para encriptarla y nos la crea.<br>
Para ver lista de contraseñas:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo pass list
</span></span></code></pre></div><p>Si queremos ver la contraseña:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo pass list /super_admin@mi_compañía.com/borg-repokey <span style="color:#ae81ff">16</span>
</span></span></code></pre></div><p>Si queremos editar la contraseña:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo pass edit /super_admin@mi_compañía.com/borg-repokey <span style="color:#ae81ff">16</span>
</span></span></code></pre></div><p>Y con esto ya está creada y lista para se usada en nuestro fichero config.yaml de borgmatic.</p>
<p>Verificamos que nuestro fichero config.yaml no contenga errores:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo validate-borgmatic-config -c /etc/borgmatic/config.yaml
</span></span></code></pre></div><h3 id="primer-backup">Primer backup<a hidden class="anchor" aria-hidden="true" href="#primer-backup">#</a></h3>
<p>El manejo de borgmatic en modo consola está muy bien explicado en la <a href="https://docs.borgbase.com/setup/borg/">web docs.borgbase.com</a>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo env <span style="color:#e6db74">&#34;PATH=</span>$PATH<span style="color:#e6db74">&#34;</span> validate-borgmatic-config
</span></span><span style="display:flex;"><span>sudo env <span style="color:#e6db74">&#34;PATH=</span>$PATH<span style="color:#e6db74">&#34;</span> borgmatic init --encryption repokey-blake2
</span></span><span style="display:flex;"><span>sudo borgmatic create --list --stats
</span></span></code></pre></div><p>Verificamos que lo ha creado:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo borgmatic list
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh://borg@IP_My_server:2222/./my_repo: Listing archives
</span></span><span style="display:flex;"><span>my_server-2025-07-30T04:22:14       Wed, 2025-07-30 04:22:17 <span style="color:#f92672">[</span>f920bbec8c5f1ff80cfb794b801f1a3d55b3a90a52047f37bf8035e57902fb51<span style="color:#f92672">]</span>
</span></span></code></pre></div><h3 id="añadimos-una-entrada-a-crontab-para-programar-los-backups-y-las-limpiezas">Añadimos una entrada a crontab para programar los backups y las limpiezas.<a hidden class="anchor" aria-hidden="true" href="#añadimos-una-entrada-a-crontab-para-programar-los-backups-y-las-limpiezas">#</a></h3>
<p>Vamos a programar nuestros backups y limpiezas a las 08.00 horas todos los días:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo crontab -e 
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># For more information see the manual pages of crontab(5) and cron(8)</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># </span>
</span></span><span style="display:flex;"><span><span style="color:#75715e"># m h  dom mon dow   command</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">0</span> <span style="color:#ae81ff">8</span> * * * /usr/bin/borgmatic --stats -v <span style="color:#ae81ff">0</span> 2&gt;&amp;<span style="color:#ae81ff">1</span>
</span></span></code></pre></div><p><strong>INFORMACIÓN IMPORTANTE SOBRE EL COMANDO BORGMATIC</strong><br>
En el <a href="https://github.com/borgmatic-collective/borgmatic/blob/main/docs/how-to/set-up-backups.md">repositorio de github borgmatic-collective</a> nos dice lo siguiente:<br>
If you omit create and other actions, borgmatic runs through a set of default actions: prune any old backups as per the configured retention policy, compact segments to free up space (with Borg 1.2+, borgmatic 1.5.23+), create a backup, and check backups for consistency problems due to things like file damage. For instance:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo borgmatic --verbosity <span style="color:#ae81ff">1</span> --list --stats
</span></span></code></pre></div><p>En resumen, cuando no añadimos otras opciones a borgmatica, éste ejecuta de forma automática por defecto las siguientes operaciones: <strong>Prune, Compact, Backups y Check de backup</strong>, lo que me parece ideal para añadir el comando en cron.</p>
<h3 id="restaurar-el-backup">Restaurar el backup<a hidden class="anchor" aria-hidden="true" href="#restaurar-el-backup">#</a></h3>
<p>Esta la segunda parte más importante. He realizado varias pruebas y todo ha funcionado correctamente. Para restaurar el backup primero hacemos un listado de los que tenemos y después montamos el backup en la ubicación deseada para restaurar los ficheros:</p>
<p>Primero listamos los ficheros creados con borgmatic:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo borgmatic list
</span></span></code></pre></div><p>Una vez sabemos el fichero que nos interesa podemos ver el contenido:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo borgmatic list --archive server-2020-04-01
</span></span></code></pre></div><p>Extracción completa de ficheros:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo borgmatic extract --archive my_server-2025-07-30T04:24:04 --destination /mnt/new-directory
</span></span></code></pre></div><p>Extracción de una parte solamente:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo borgmatic extract --archive my_server-2020-04-01 --path mnt/catpics --destination /mnt/new-directory
</span></span></code></pre></div><h3 id="notificaciones-del-backup-usando-apprise">Notificaciones del Backup usando apprise<a hidden class="anchor" aria-hidden="true" href="#notificaciones-del-backup-usando-apprise">#</a></h3>
<p>Instalamos el software necesario. Según su <a href="https://github.com/caronc/apprise">github</a> Apprise permite enviar una notificación a casi todos los servicios de notificación más populares disponibles en la actualidad, como: Telegram, Discord, Slack, Amazon SNS, Gotify, etc.</p>
<p>Instalación es sencilla:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo apt install apprise
</span></span></code></pre></div><p>Configuración de nuestro fichero borgmatic conf:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo nano /etc/borgmatic/config.yaml
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#### AÑADIMOS ESTO AL FINAL de nuestro fichero de configuración</span>
</span></span><span style="display:flex;"><span>hooks:
</span></span><span style="display:flex;"><span>  before_backup:
</span></span><span style="display:flex;"><span>    - echo <span style="color:#e6db74">&#34;Starting a backup job.&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  after_backup:
</span></span><span style="display:flex;"><span>    - echo <span style="color:#e6db74">&#34;Backup created.&#34;</span>
</span></span><span style="display:flex;"><span>    - apprise -vv -t <span style="color:#e6db74">&#34;✅ SUCCESS Backup My_Server&#34;</span> -b <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat /tmp/backup_run.log<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;mailtos://smtp.gmail.com:587?user=super_admin@gmail.com&amp;pass=superpasssecreta&amp;from=superadmin@gmail.com&amp;to=superadmin@hotmail.com,tgram://bot_token:de_telegram/chat_id_telegram/&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  on_error:
</span></span><span style="display:flex;"><span>    - echo <span style="color:#e6db74">&#34;Error while creating a backup.&#34;</span>
</span></span><span style="display:flex;"><span>    - apprise -vv -t <span style="color:#e6db74">&#34;❌ FAILED Backup My_Server&#34;</span> -b <span style="color:#e6db74">&#34;</span><span style="color:#66d9ef">$(</span>cat /tmp/backup_run.log<span style="color:#66d9ef">)</span><span style="color:#e6db74">&#34;</span> <span style="color:#e6db74">&#34;mailtos://smtp.gmail.com:587?user=super_admin@gmail.com&amp;pass=superpasssecreta&amp;from=superadmin@gmail.com&amp;to=superadmin@hotmail.com,tgram://bot_token:de_telegram/chat_id_telegram/&#34;</span>
</span></span></code></pre></div><p>En mi caso he configurado para que nos envíe dos notificaciones. La primera por correo electrónico y la segunda a Telegram.</p>
<p>En la versión de borgmatic 1.8.4+ Apprise se integra de forma nativa con borgmatic, lo que permite una configuración mucho más limpia, tal y como se muestra en la siguiente ejemplo. Esta configuración yo no puedo usarla porque mi sistema tiene la versión borgmatic 1.7.7:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>apprise:
</span></span><span style="display:flex;"><span>    states:
</span></span><span style="display:flex;"><span>        - start
</span></span><span style="display:flex;"><span>        - finish
</span></span><span style="display:flex;"><span>        - fail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    services:
</span></span><span style="display:flex;"><span>        - url: mailtos://smtp.example.com:587?user<span style="color:#f92672">=</span>server@example.com&amp;pass<span style="color:#f92672">=</span>YourSecurePassword&amp;from<span style="color:#f92672">=</span>server@example.com&amp;to<span style="color:#f92672">=</span>receiver@example.com
</span></span><span style="display:flex;"><span>          label: mail
</span></span><span style="display:flex;"><span>        - url: slack://token@Txxxx/Bxxxx/Cxxxx
</span></span><span style="display:flex;"><span>          label: slack
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    start:
</span></span><span style="display:flex;"><span>        title: ⚙️ Started
</span></span><span style="display:flex;"><span>        body: Starting backup process.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    finish:
</span></span><span style="display:flex;"><span>        title: ✅ SUCCESS
</span></span><span style="display:flex;"><span>        body: Backups successfully made.
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>    fail:
</span></span><span style="display:flex;"><span>        title: ❌ FAILED
</span></span><span style="display:flex;"><span>        body: Your backups have failed.
</span></span></code></pre></div><p>En la versión 1.8.9+, los logs de borgmatic son añadidos automaticamenta al cuerpo de las notificaciones de apprise. Me parece una colaboración impresionante. <strong>Que ganas tengo de que actualice Debian a la nueva versión de borgmatic</strong>.</p>
<p>Por último, modificamos nuestro crontab para que al ejecutarse guarde la salida de las estadísticas en el fichero <strong>/tmp/backup_run.log</strong>.</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>sudo crontab -e
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#75715e">#</span>
</span></span><span style="display:flex;"><span><span style="color:#ae81ff">30</span> <span style="color:#ae81ff">8</span> * * * /usr/bin/borgmatic --stats -v <span style="color:#ae81ff">0</span> &gt; /tmp/backup_run.log
</span></span></code></pre></div><p>Con esto, nuestro borgmatica ya debería notificarnos:</p>
<p>Correo:<br>
<img alt="borg-client-8.png" loading="lazy" src="/posts/borg-backups/borg-client-8.png"></p>
<p>Telegram:<br>
<img alt="borg-client-9.png" loading="lazy" src="/posts/borg-backups/borg-client-9.png"></p>
<h3 id="notas-finales-a-tener-en-cuenta">Notas finales a tener en cuenta<a hidden class="anchor" aria-hidden="true" href="#notas-finales-a-tener-en-cuenta">#</a></h3>
<p>En mi servidor sanmi tengo instalado <a href="https://fedoraproject.org/es/server/download">Fedora Server</a>. En este caso, la versión de borgmatic que nos acompaña es la versión 2.0.6 por lo que ya disponemos de las nuevas características para notificaciones y de un nuevo formato en el fichero config.yaml.</p>
<p>Respecto a la configuración de <strong>encryption_passcommand</strong> en borgmatic, se me presenta un problema.<br>
Si programamos el backup con cron, no se ejecuta. El motivo es que cada vez que se va a ejecutar, el comando <strong>pass</strong> nos solicita nuestra contraseña de la clave gpg y si no la introducimos el resto no continúa. Entonces, para que los backups se realicen de forma automática sin intervención del usuario, la única forma que he conseguido hacerlo es poniendo la contraseña directamente en el fichero config.yaml.</p>
<p>Configuración de mi fichero <strong>config.yaml</strong> en Fedora Server:</p>
<div class="highlight"><pre tabindex="0" style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4;-webkit-text-size-adjust:none;"><code class="language-bash" data-lang="bash"><span style="display:flex;"><span>source_directories:
</span></span><span style="display:flex;"><span>  - /home/AppData
</span></span><span style="display:flex;"><span>  - /home/super_admin
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>repositories:
</span></span><span style="display:flex;"><span>  - path: ssh://borg@100.100.100.100:2222/./sanMi
</span></span><span style="display:flex;"><span>    label: sanMi
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>exclude_caches: true
</span></span><span style="display:flex;"><span>exclude_patterns:
</span></span><span style="display:flex;"><span>  - <span style="color:#e6db74">&#39;*.pyc&#39;</span>
</span></span><span style="display:flex;"><span>  - /home/*/.cache
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>compression: auto,zstd
</span></span><span style="display:flex;"><span>encryption_passphrase: My_super_password
</span></span><span style="display:flex;"><span><span style="color:#75715e">#encryption_passcommand: pass /super_admin@gmail.com/borg-repokey</span>
</span></span><span style="display:flex;"><span>archive_name_format: <span style="color:#e6db74">&#34;{hostname}-{now}&#34;</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>ssh_command: ssh -i /root/.ssh/sanmi
</span></span><span style="display:flex;"><span>retries: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>retry_wait: <span style="color:#ae81ff">5</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>keep_daily: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>keep_weekly: <span style="color:#ae81ff">4</span>
</span></span><span style="display:flex;"><span>keep_monthly: <span style="color:#ae81ff">12</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>checks:
</span></span><span style="display:flex;"><span>  - name: repository
</span></span><span style="display:flex;"><span>    frequency: <span style="color:#ae81ff">4</span> weeks
</span></span><span style="display:flex;"><span>  - name: archives
</span></span><span style="display:flex;"><span>    frequency: <span style="color:#ae81ff">8</span> weeks
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>check_last: <span style="color:#ae81ff">3</span>
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>apprise:
</span></span><span style="display:flex;"><span>  states:
</span></span><span style="display:flex;"><span>    - start
</span></span><span style="display:flex;"><span>    - finish
</span></span><span style="display:flex;"><span>    - fail
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  services:
</span></span><span style="display:flex;"><span>    - url: mailtos://smtp.gmail.com:587?user<span style="color:#f92672">=</span>super_admin_@gmail.com&amp;pass<span style="color:#f92672">=</span>super_password&amp;from<span style="color:#f92672">=</span>super_admin@gmail.com&amp;to<span style="color:#f92672">=</span>destino@hotmail.com
</span></span><span style="display:flex;"><span>      label: mail
</span></span><span style="display:flex;"><span>    - url: tgram://123456789:AAE39Q5XXXXXXXXXXXXXXX_XXXXXXXXXXXXXXXXXXXxPGrI/XXXXXXXXXXXX/
</span></span><span style="display:flex;"><span>      label: telegram
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  start:
</span></span><span style="display:flex;"><span>    title: ⚙️ Starrted Backup
</span></span><span style="display:flex;"><span>    body: Starting backup process
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  finish:
</span></span><span style="display:flex;"><span>    title: ✅ SUCCESS Backup SanMi
</span></span><span style="display:flex;"><span>    body: Backup SanMi success
</span></span><span style="display:flex;"><span>
</span></span><span style="display:flex;"><span>  fail:
</span></span><span style="display:flex;"><span>    title: ❌ FAILED Backup SanMi
</span></span><span style="display:flex;"><span>    body: Backups SanMi failed
</span></span></code></pre></div><hr>
<p>Fuentes y enlaces de interés que ayudaran a complementar esta guía:</p>
<p><a href="https://hub.docker.com/r/nold360/borgserver">Borgserver en hub.docker.com</a> <br>
<a href="https://willbrowning.me/automated-offsite-encrypted-backups-with-borg-backup/">Guía muy completa, base de casi todo el manual</a><br>
<a href="https://es.linux-console.net/?p=9687">Guía en español con detalle de uso contraseña cifrado</a><br>
<a href="https://tutoriales.bilito.eu/automatizar-backups-de-nuestro-unraid-con-borg/">Tutorial bilito para configurar borg en Unraid</a><br>
<a href="https://es.unixlinux.online/ix/1002011444.html">Guía en español configuración pass y claves gpg para almacenar esas pass</a><br>
<a href="https://linuxconfig.org/how-to-organize-your-passwords-using-pass-password-manager">Configuración de pass como password-manager en consola</a><br>
<a href="https://docs.borgbase.com/">Documentación Borgbase.com</a><br>
<a href="https://github.com/borgmatic-collective/borgmatic/blob/main/docs/how-to/set-up-backups.md">Github de borgmatic-collective con ejemplos varios</a><br>
<a href="https://github.com/caronc/apprise">Notificaciones con apprise</a><br>
<a href="https://github.com/borgmatic-collective/docker-borgmatic">Github de borgmatic-collective notificaciones apprise</a><br>
<a href="https://github.com/caronc/apprise/wiki/Notify_telegram">Doc notificaciones apprise Telegram</a></p>


  </div>

  <footer class="post-footer">
    <ul class="post-tags">
      <li><a href="https://blog.lasnotasdenoah.com/tags/backups/">Backups</a></li>
    </ul>
  </footer>
</article>
    </main>
    
<footer class="footer">
        <span>&copy; 2026 <a href="https://blog.lasnotasdenoah.com/">Las notas de Noah</a></span> · 

    <span>
        Powered by
        <a href="https://gohugo.io/" rel="noopener noreferrer" target="_blank">Hugo</a> &
        <a href="https://github.com/adityatelange/hugo-PaperMod/" rel="noopener" target="_blank">PaperMod</a>
    </span>
</footer>
<a href="#top" aria-label="go to top" title="Go to Top (Alt + G)" class="top-link" id="top-link" accesskey="g">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentColor">
        <path d="M12 6H0l6-6z" />
    </svg>
</a>

<script>
    let menu = document.getElementById('menu');
    if (menu) {
        
        const scrollPosition = localStorage.getItem("menu-scroll-position");
        if (scrollPosition) {
            menu.scrollLeft = parseInt(scrollPosition, 10);
        }
        
        menu.onscroll = function () {
            localStorage.setItem("menu-scroll-position", menu.scrollLeft);
        }
    }

    document.querySelectorAll('a[href^="#"]').forEach(anchor => {
        anchor.addEventListener("click", function (e) {
            e.preventDefault();
            var id = this.getAttribute("href").substr(1);
            if (!window.matchMedia('(prefers-reduced-motion: reduce)').matches) {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView({
                    behavior: "smooth"
                });
            } else {
                document.querySelector(`[id='${decodeURIComponent(id)}']`).scrollIntoView();
            }
            if (id === "top") {
                history.replaceState(null, null, " ");
            } else {
                history.pushState(null, null, `#${id}`);
            }
        });
    });

</script>
<script>
    var mybutton = document.getElementById("top-link");
    window.onscroll = function () {
        if (document.body.scrollTop > 800 || document.documentElement.scrollTop > 800) {
            mybutton.style.visibility = "visible";
            mybutton.style.opacity = "1";
        } else {
            mybutton.style.visibility = "hidden";
            mybutton.style.opacity = "0";
        }
    };

</script>
<script>
    document.getElementById("theme-toggle").addEventListener("click", () => {
        const html = document.querySelector("html");
        if (html.dataset.theme === "dark") {
            html.dataset.theme = 'light';
            localStorage.setItem("pref-theme", 'light');
        } else {
            html.dataset.theme = 'dark';
            localStorage.setItem("pref-theme", 'dark');
        }
    })

</script>
<script>
    document.querySelectorAll('pre > code').forEach((codeblock) => {
        const container = codeblock.parentNode.parentNode;

        const copybutton = document.createElement('button');
        copybutton.classList.add('copy-code');
        copybutton.innerHTML = 'copy';

        function copyingDone() {
            copybutton.innerHTML = 'copied!';
            setTimeout(() => {
                copybutton.innerHTML = 'copy';
            }, 2000);
        }

        copybutton.addEventListener('click', (cb) => {
            if ('clipboard' in navigator) {
                navigator.clipboard.writeText(codeblock.textContent);
                copyingDone();
                return;
            }

            const range = document.createRange();
            range.selectNodeContents(codeblock);
            const selection = window.getSelection();
            selection.removeAllRanges();
            selection.addRange(range);
            try {
                document.execCommand('copy');
                copyingDone();
            } catch (e) { };
            selection.removeRange(range);
        });

        if (container.classList.contains("highlight")) {
            container.appendChild(copybutton);
        } else if (container.parentNode.firstChild == container) {
            
        } else if (codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName == "TABLE") {
            
            codeblock.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(copybutton);
        } else {
            
            codeblock.parentNode.appendChild(copybutton);
        }
    });
</script>
</body>

</html>
